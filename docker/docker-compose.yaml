version: '3.8'

x-airflow-common: &airflow-common
  build:
    context: ..
    dockerfile: docker/Dockerfile
  environment: &airflow-env
    # Airflow 2.x configuration
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "false"

    # Python environment
    PYTHONPATH: /opt/airflow

    # Pipeline configuration
    PIPELINE_CONFIG: /opt/airflow/configs/config.yaml

    # PostgreSQL configuration
    DB_HOST: postgres
    DB_USER: pipeline_user
    DB_PASSWORD: pipeline_password
    DB_NAME: pipeline

    # MinIO configuration
    MINIO_ENDPOINT: minio:9000
    MINIO_ACCESS_KEY: minioadmin
    MINIO_SECRET_KEY: minioadmin

    # Rada API configuration
    RADA_API_TOKEN: f822823f-ff12-4583-8160-0fd9db40507f

  volumes:
    - ../dags:/opt/airflow/dags
    - ../pipeline:/opt/airflow/pipeline
    - ../configs:/opt/airflow/configs
    - ../scripts:/opt/airflow/scripts
    - ../outputs/logs:/opt/airflow/logs
    - ../data:/opt/airflow/data
  depends_on:
    postgres:
      condition: service_healthy
    minio:
      condition: service_healthy
  networks:
    - pipeline-network

services:
  # PostgreSQL - Airflow metadata DB + Pipeline DB
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
      POSTGRES_INITDB_ARGS: "-E UTF8"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5432:5432"
    networks:
      - pipeline-network

  # MinIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - pipeline-network

  # MinIO Init - Create buckets
  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing local/raw;
      mc mb --ignore-existing local/processed;
      mc mb --ignore-existing local/dictionaries;
      mc mb --ignore-existing local/pipeline-temp;
      echo 'Buckets created successfully';
      "
    networks:
      - pipeline-network
    restart: "no"

  # Airflow Init - Database initialization
  airflow-init:
    <<: *airflow-common
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create \
          --username admin \
          --password admin \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com || true
    restart: "no"

  # Airflow Webserver - Web UI
  airflow-webserver:
    <<: *airflow-common
    command: webserver
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  # Airflow Scheduler - Task scheduler and executor
  airflow-scheduler:
    <<: *airflow-common
    command: scheduler
    healthcheck:
      test: ["CMD-SHELL", "airflow jobs check --job-type SchedulerJob --hostname $$(hostname)"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      airflow-init:
        condition: service_completed_successfully

volumes:
  postgres-data:
    driver: local
  minio-data:
    driver: local

networks:
  pipeline-network:
    driver: bridge
